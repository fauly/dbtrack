<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archived Reports</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f9f9f9;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .search-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .search-section input[type="date"] {
            padding: 5px;
            font-size: 16px;
        }
        .strike {
            text-decoration: line-through;
            color: red;
        }
        .completion-time {
            color: green;
            margin-left: 10px;
            font-style: italic;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const dateInput = document.getElementById("date-input");
            const reportDate = document.getElementById("report-date");
            const lastEdited = document.getElementById("last-edited");
            const reportForm = document.getElementById("report-form");
            let timeout;

            async function fetchReport(date) {
                try {
                    const response = await fetch(`/api/archived-report?date=${date}`);
                    const data = await response.json();
                    if (data.error) {
                        reportDate.innerHTML = `<p>${data.error}</p>`;
                        reportForm.style.display = "none";
                    } else {
                        reportDate.innerHTML = `Report for ${data.date}`;
                        lastEdited.innerHTML = `Last edited: ${data.last_edited || "Not yet edited"}`;
                        loadFormData(data);
                        reportForm.style.display = "block";
                    }
                } catch (error) {
                    console.error("Error fetching report:", error);
                }
            }

            function loadFormData(data) {
                document.querySelectorAll("input[type='text']").forEach((input) => {
                    const key = input.dataset.field;
                    input.value = data[key] || "";
                });

                document.querySelectorAll("input[type='checkbox']").forEach((checkbox) => {
                    const key = checkbox.dataset.field;
                    checkbox.checked = data[key] === true || data[key] === "true";
                    handleCheckboxDisplay(checkbox, checkbox.checked);
                });
            }

            function handleCheckboxDisplay(checkbox, isChecked) {
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                const time = new Date().toLocaleTimeString();
                if (isChecked) {
                    label.classList.add("strike");
                    label.innerHTML += `<span class="completion-time">(${time})</span>`;
                } else {
                    label.classList.remove("strike");
                    label.querySelector(".completion-time")?.remove();
                }
            }

            async function updateField(field, value) {
                clearTimeout(timeout);
                timeout = setTimeout(async () => {
                    try {
                        const response = await fetch("/api/update", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ field, value, date: dateInput.value }),
                        });
                        const result = await response.json();
                        if (!result.success) console.error("Error updating field:", result.error);
                    } catch (error) {
                        console.error("Error updating field:", error);
                    }
                }, 300);
            }

            document.getElementById("fetch-report").addEventListener("click", () => {
                const date = dateInput.value;
                if (!date) {
                    alert("Please select a date.");
                    return;
                }
                fetchReport(date);
            });

            document.querySelectorAll("input").forEach((input) => {
                input.addEventListener("change", (e) => {
                    const field = e.target.dataset.field;
                    const value = e.target.type === "checkbox" ? e.target.checked : e.target.value;
                    if (e.target.type === "checkbox") handleCheckboxDisplay(e.target, e.target.checked);
                    updateField(field, value);
                });
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>Archived Reports</h1>
        <div class="search-section">
            <label for="date-input">Select a date:</label>
            <input type="date" id="date-input">
            <button id="fetch-report">Fetch Report</button>
        </div>
        <h2 id="report-date">No report selected</h2>
        <div id="report-form" style="display: none;">
            <!-- The report form will be dynamically populated -->
        </div>
        <div id="last-edited" style="text-align: center; margin-top: 20px; font-style: italic; color: gray;">
            Last edited: Not yet edited
        </div>
    </div>
</body>
</html>
